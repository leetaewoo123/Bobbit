{% extends 'base/base.html' %}
{% load static %}
{% block head %}
<link href="{% static 'css/bootstrap.css' %}" rel="stylesheet">
<link href="{% static 'css/pricePredict/price.css' %}" rel="stylesheet">
<link href="{% static 'css/pricePredict/bootstrap-datepicker.css' %}" rel="stylesheet">
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
{% endblock head %}

{% block contents %}
    <div class ="p_Container">
        <div class = "catagori-Nav">
        {% for pd in pd_list %}
        <li class="page-item">
            {% if pd.pNo ==  product_info.pNo %}
            <a class="select" href='../{{ pd.pNo }}'>
                {{ pd.pName }}
            </a>
            {% else %}
            <a class="non-select" href='../{{ pd.pNo }}'>
                {{ pd.pName }}
            </a>
            {% endif %}
        </li>
        {% endfor %}
        </div>
        <section class = "title_section">
            <h1>{{icon}} {{product_info.pName}}</h1>
            <li> ÎåÄÌòïÎßàÌä∏ "ÏõêÍ∞Ä" Í∏∞Ï§Ä</li>
        </section>
        <div class= "line"></div>
        <div id = "content-area">
            <div id = "content_1">
                <div class = "datearea">
                    <li>ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥ ÏõêÌïòÎäî Ï∞®Ìä∏Î•º Ïù¥ÎèôÌï¥Î≥¥ÏÑ∏Ïöîüëâ</li>
                    <div class = "datepicker">
                        <input type="text" id="datePicker" value={{today.year}}-{{today.month}}-{{today.day}}>
                    </div>
                </div>
                <section class ="chartarea">
                    <div id="chartdiv"></div>
                </section>
            </div>
            <div id = "content_2">
                <div class="predict">
                    <span class = "pre_div name_section" id = "p_Name">
                        <p>{{product_info.pName}}</p>
                        <div class = "heart_section">
                          {% if isLike %}
                          <div class="wish heart"> </div>
                          {% else %}
                          <div class="wish cleanheart"> </div>
                          {% endif %}
                          <p id="count">
                              {{ wish_count }}
                          </p>
                        </div>
                    </span>
                    <span class = "pre_div">
                        <h1 id ="p_Month">{{lastmonth}}</h1>
                        <p>Ïõî ÎåÄÎπÑ</p>
                        {% if next_price > now_price %}
                        <div id = "up_Box">
                            <span>
                            <p class = "icon">‚ñº&nbsp&nbsp&nbsp</p>
                            <h1>
                                <script>
                                document.write(Math.abs(Math.round({{next_price}}-{{now_price}})));
                                </script>
                            </h1>
                            <p>Ïõê</p>
                            </span>
                            <span>
                                <p class = "icon">‚ñ≤&nbsp&nbsp&nbsp</p>
                                <h1>
                                    <script>
                                    document.write(Math.abs(Math.round(({{next_price}}-{{now_price}}) / {{now_price}} * 100 * 100) /100));
                                    </script>
                                </h1>
                                <p>%</p>
                            </span>
                        </div>
                        {% else %}
                        <div id = "down_Box">
                            <span>
                            <p class = "icon">‚ñº&nbsp&nbsp&nbsp</p>
                            <h1>
                                <script>
                                document.write(Math.abs(Math.round({{next_price}}-{{now_price}})));
                                </script>
                            </h1>
                            <p>Ïõê</p>
                            </span>
                            <span>
                                <p class = "icon">‚ñº&nbsp&nbsp&nbsp</p>
                                <h1>
                                    <script>
                                    document.write(Math.abs(Math.round(({{next_price}}-{{now_price}}) / {{now_price}} * 100 * 100) /100));
                                    </script>
                                </h1>
                                <p>%</p>
                            </span>
                        </div>
                        {% endif %}
                        <p>ÏòàÏÉÅÎê©ÎãàÎã§</p>
                    </span >
                    <span class = "pre_div">
                        <form name="form1">
                              <ul id="info">
                                <li>
                                  <div class = "box" id = "now_price">
                                    <label for="price"> ÌòÑÏû¨ Í∞ÄÍ≤©(1Í∞ú)</label>
                                    <div>
                                    <input type="text" name="price" value={{now_price}} style="width:100px; height:30px" readonly>Ïõê
                                    </div>
                                  </div>
                                </li>
                                <li>
                                    <div class = "box" id = "quantity_box">
                                      <label for="quantity">ÏàòÎüâ</label>
                                      <div class = "button-box">
                                      <input id = "text" type="text" name="quantity" value="1" max="" style="width:100px; height:30px">
                                      <input id = "button" type="button" value=" + " name="add">
                                      <input id = "button" type="button" value=" - " name="minus">
                                      </div>
                                    </div>
                                </li>
                                <li>
                                  {% if user.is_authenticated %}
                                    <div class = "box" id = "buy_box" data-toggle="modal" data-target="#exampleModalCenter">
                                  {% else %}    
                                    <div class = "box" id = "buy_box">
                                  {% endif %} 
                                        <label for="total">Íµ¨Îß§</label>
                                        <div class = "button-box">
                                        <input id = "text" type="text" name="total" value="{{totalVal}}" style="width:100px; height:30px" readonly>p
                                        </div>
                                    </div>
                                </li>
                              </ul>
                              <!-- Modal -->
                            {% comment %} <div>
                              {% if request.session %}
                                <input type="submit" class="purchase" value="Íµ¨Îß§" onclick="alert('Íµ¨Îß§Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.')">
                              {% else %}
                                <input type="button" class="login" value="Íµ¨Îß§" onclick="windows.open('../../accounts/login')">
                              {% endif %}
                            </div> {% endcomment %}
                          </form>
                    </span>
                </div>
            </div>
        </div>
        <div class= "line"></div>
        <div id="recommend-area">
          <h2> Íµ¨Îß§Ï∂îÏ≤ú</h2>
          <h6 class = "sub-title"> Ìï¥Îãπ Í∞ÄÍ≤©ÏùÄ coupang Îû≠ÌÇπ Í∏∞Ï§ÄÏúºÎ°ú Î∞òÏòÅÎê©ÎãàÎã§.</h6>
          <div class="others" style="padding-left:50px">
              {% for pd in crawlingdata %}
              <div id = "product_row">
                  <p class = "name">{{pd.pName}}</p>
                  {% if pd.pFree == True %}
                  <p class = "free"><u>Î∞∞ÏÜ°ÎπÑ Ìè¨Ìï®</u></p>
                  {% else %}
                  <p class = "notfree"><u>Î∞∞ÏÜ°ÎπÑ ÎØ∏Ìè¨Ìï®</u></p>
                  {% endif %}
                  <p class = "price">{{pd.price}}Ïõê</p>
                  <input class = "button" type="button" value="Íµ¨Îß§ÌïòÎü¨ Í∞ÄÍ∏∞" onclick="window.open('{{ pd.plink }}')"><br>
                </div>
              {% endfor %}
          </div>
        </div>
    </div>
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Íµ¨Îß§</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <table class = "price-table">
              <colgroup>
                <col width = "50%">
                <col width = "50%">
              </colgroup>
              <tbody>
                <tr>
                  <th>Î≥¥Ïú† Ìè¨Ïù∏Ìä∏</th>
                  <td id = "now_p">{{ user.point }}</td>
                </tr>
                <tr class ="deduct">
                  <th>Ï∞®Í∞ê Ìè¨Ïù∏Ìä∏</th>
                  <td id = "deduct_p">{{ now_price }}</td>
                </tr>
                <tr class ="residual">
                  <th>ÏûîÏó¨ Ìè¨Ïù∏Ìä∏</th>
                  <td id = "remain_p">0</td>
                </tr>
              </tbody>
            </table>
            Íµ¨Îß§Ìï†ÍπåÏöî?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Ï∑®ÏÜå</button>
            <button type="button" id = "buynow" class="btn btn-primary">Íµ¨Îß§ÌïòÍ∏∞</button>
          </div>
        </div>
      </div>
{% endblock contents %}

{% block script_section %}
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
{% comment %} <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script> {% endcomment %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    let xss_str = "{{pd_data}}";
    xss_str = xss_str.replace(/&quot;/g,'"');
    let price_data = JSON.parse(xss_str)
    let next_price = Math.round({{next_price}})
    let next_date = "{{today.year}}-{{today.month}}-01"
</script>
<script src="{% static 'js/pricePredict/amcharts.js'%}"></script>
<script src="{% static 'js/pricePredict/bootstrap-datepicker.js'%}"></script>
<script>
    const csrftoken = getCookie('csrftoken');
	$(function() {
		$('#datePicker').datepicker({
		    format: "yyyy-mm-dd",	//Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ ÌòïÏãù(yyyy : ÎÖÑ mm : Ïõî dd : Ïùº )
		    autoclose : true,	//ÏÇ¨Ïö©ÏûêÍ∞Ä ÎÇ†ÏßúÎ•º ÌÅ¥Î¶≠ÌïòÎ©¥ ÏûêÎèô Ï∫òÎ¶∞ÎçîÍ∞Ä Îã´ÌûàÎäî ÏòµÏÖò
		    clearBtn : true, //ÎÇ†Ïßú ÏÑ†ÌÉùÌïú Í∞í Ï¥àÍ∏∞Ìôî Ìï¥Ï£ºÎäî Î≤ÑÌäº Î≥¥Ïó¨Ï£ºÎäî ÏòµÏÖò Í∏∞Î≥∏Í∞í false Î≥¥Ïó¨Ï£ºÎ†§Î©¥ true
		    showWeekDays : true ,// ÏúÑÏóê ÏöîÏùº Î≥¥Ïó¨Ï£ºÎäî ÏòµÏÖò Í∏∞Î≥∏Í∞í : true
		    title: "ÎÇ†Ïßú ÏÑ†ÌÉù",	//Ï∫òÎ¶∞Îçî ÏÉÅÎã®Ïóê Î≥¥Ïó¨Ï£ºÎäî ÌÉÄÏù¥ÌãÄ
		    todayHighlight : true ,	//Ïò§Îäò ÎÇ†ÏßúÏóê ÌïòÏù¥ÎùºÏù¥ÌåÖ Í∏∞Îä• Í∏∞Î≥∏Í∞í :false 
		    language : "ko"	//Îã¨Î†•Ïùò Ïñ∏Ïñ¥ ÏÑ†ÌÉù, Í∑∏Ïóê ÎßûÎäî jsÎ°ú ÍµêÏ≤¥Ìï¥Ï§òÏïºÌïúÎã§.
		}).on("changeDate", function(e){

        })
	})
</script>
<script type="text/javascript">
  const now_point = document.getElementById("now_p");
  const deduct_price = document.getElementById("deduct_p");
  const remain_price = document.getElementById("remain_p");
  const formform = document.getElementsByName("form1"),
        price = document.form1.price,
        quantity = document.form1.quantity,
        add = document.form1.add,
        minus = document.form1.minus,
        total = document.form1.total;

  let quantityVal;
  let totalVal;
  let priceVal;
  remain_price.innerHTML = now_point.innerHTML - deduct_price.innerHTML;

  if(remain_price.innerHTML < 0){
    remain_price.style.color = 'red';
  }

  if (formform){
    total.value = price.value;

    quantityVal = quantity.value;
    totalVal = total.value;
    priceVal = price.value;

    if(add){
      add.addEventListener('click', function(){
        quantityVal++;
        totalVal = quantityVal * priceVal;
        quantity.value = quantityVal;
        total.value = totalVal;
        deduct_price.innerHTML  = totalVal;
        remain_price.innerHTML = now_point.innerHTML - totalVal;
        if(remain_price.innerHTML < 0){
          remain_price.style.color = 'red';
        }else{
          remain_price.style.color = 'black';
        }
      })
    }
      
    if(minus){
      minus.addEventListener('click', function(){
        if (quantityVal > 1){
          quantityVal--;
          totalVal = quantityVal * priceVal;
          quantity.value = quantityVal;
          total.value = totalVal;
          deduct_price.innerHTML  = totalVal;
          remain_price.innerHTML = now_point.innerHTML - totalVal;
          if(remain_price.innerHTML < 0){
            remain_price.style.color = 'red';
          }else{
            remain_price.style.color = 'black';
          }
      }else{
        quantityVal = 1;
        }
      })
    }
  }
</script>
{% comment %} „Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°Ï∞úÌïòÍ∏∞„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö° {% endcomment %}
<script type="text/javascript">
  $(".wish").click(function () { // .like Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ Í∞êÏßÄ
    {% if user.is_authenticated %}
      $.ajax({ // ajaxÎ°ú ÏÑúÎ≤ÑÏôÄ ÌÜµÏã†
          type: "POST", // Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏÜ°ÌïòÎäî Î∞©Î≤ï
          url: "./wish/", // ÌÜµÏã†Ìï† urlÏùÑ ÏßÄÏ†ï
          data: {'csrfmiddlewaretoken': '{{ csrf_token }}' }, // ÏÑúÎ≤ÑÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°Ïãú ÏòµÏÖò, pkÎ•º ÎÑòÍ≤®Ïïº Ïñ¥Îñ§ videoÏù∏ÏßÄ Ïïå Ïàò ÏûàÏùå
          dataType: "json",
          success: function (response) { // ÏÑ±Í≥µ
              alert(response.message);
              $("#count").html(response.wish_count); // Ï¢ãÏïÑÏöî Í∞úÏàò Î≥ÄÍ≤Ω
              if(response.message == "Ï¢ãÏïÑÏöî"){
                $(".wish").attr('class', 'wish heart')
              }else{
                $(".wish").attr('class', 'wish cleanheart')
              }
          },
          error: function (request, status, error) { // Ïã§Ìå®
          },   
      });
      {% else %}
      window.location.replace("/accounts/login/") // Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú ÎÑòÏñ¥Í∞ÄÍ∏∞
      {% endif %}
  })
</script>
{% comment %} „Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°Íµ¨Îß§ÌïòÍ∏∞„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö°„Ö° {% endcomment %}

<script type="text/javascript">

  $("#buy_box").click(function () { // .like Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ Í∞êÏßÄ
    {% if not user.is_authenticated %}
      alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú ÏÑúÎπÑÏä§ÏûÖÎãàÎã§.")
      window.location.replace("/accounts/login/") // Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú ÎÑòÏñ¥Í∞ÄÍ∏∞
    {% endif %}
  });

  //Íµ¨Îß§Î≤ÑÌäº ÎàåÎ†ÄÏùÑÎïå
  $("#buynow").click(function () { // .like Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ Í∞êÏßÄ
    {% if user.is_authenticated %}

    if(remain_price.innerHTML < 0){
      alert('Ìè¨Ïù∏Ìä∏Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.')
    }else{
      $.ajax({ // ajaxÎ°ú ÏÑúÎ≤ÑÏôÄ ÌÜµÏã†
        type: "POST", // Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏÜ°ÌïòÎäî Î∞©Î≤ï
        url: "./buy/", // ÌÜµÏã†Ìï† urlÏùÑ ÏßÄÏ†ï
        data: {'quantityVal' : quantityVal,
        'priceVal' : priceVal,
        'csrfmiddlewaretoken': '{{ csrf_token }}' }, 
        dataType: "json",
        success: function (response) { // ÏÑ±Í≥µ
            if(response.content){
              alert('Íµ¨Îß§ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.')
              window.location.replace("./")
            }
        },
        error: function (request, status, error) { // Ïã§Ìå®
        },   
      })
    }
    {% else  %}
      alert("ÎπÑÏ†ïÏÉÅÏ†ÅÏù∏ Ï†ëÍ∑ºÏûÖÎãàÎã§.")
    {% endif %}
});
</script>
{% endblock script_section %}